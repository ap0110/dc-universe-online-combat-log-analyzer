<html>
<head>
<meta charset="utf-8">

<!--
//********************************************************************
//*  Description:   Creates a configuration web page for the user to 
//*     enter in information about characters that isn't gotten from 
//*     the combat.log file.  For example, what the character's mentor
//*     is.  We use this for determining what feats are available for 
//*     the character
//********************************************************************

// Copyright (c) 2011,2012 
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), 
// to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, 
// and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, 
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE 
// OR OTHER DEALINGS IN THE SOFTWARE.
-->


</head>
<body>

<style>
  #progress_bar {
    margin: 10px 0;
    padding: 3px;
    border: 1px solid #000;
    font-size: 14px;
    clear: both;
    opacity: 0;
    -moz-transition: opacity 1s linear;
    -o-transition: opacity 1s linear;
    -webkit-transition: opacity 1s linear;
  }
  #progress_bar.loading {
    opacity: 1.0;
  }
  #progress_bar .percent {
    background-color: #99ccff;
    height: auto;
    width: 0;
  }
</style>

<br>
<form>
For character:
<select id="DropDownMenu_Character" name="DropDownMenu_Character" onchange="javascript:fillData();"></select>
<br>
<table id="table0" width="100%">
  <tr>
    <td>
      Mentor:
    </td>
    <td>
      <input type="radio" name="mentor" id="mentorBatman"          />Batman
      <input type="radio" name="mentor" id="mentorSuperman"        />Superman
      <input type="radio" name="mentor" id="mentorWonderWoman"     />Wonder Woman
      <input type="radio" name="mentor" id="mentorJoker"           />Joker
      <input type="radio" name="mentor" id="mentorLexLuthor"       />Lex Luthor
      <input type="radio" name="mentor" id="mentorCirce"           />Circe
    </td>
  </tr>
  <tr>
    <td>
      Movement Mode:
    </td>
    <td>
      <input type="radio" name="movement" id="movementAcrobatics"  />Acrobatics
      <input type="radio" name="movement" id="movementFlight"      />Flight
      <input type="radio" name="movement" id="movementSuperspeed"  />Superspeed
    </td>
  </tr>
  <tr>
    <td>
      Powerset:
    </td>
    <td>
      <input type="radio" name="powerset" id="powersetGadgets"     />Gadgets
      <input type="radio" name="powerset" id="powersetMental"      />Mental
      <input type="radio" name="powerset" id="powersetHardLight"   />Hard Light
      <input type="radio" name="powerset" id="powersetElectric"    />Electric
      <input type="radio" name="powerset" id="powersetNature"      />Nature
      <input type="radio" name="powerset" id="powersetSorcery"     />Sorcery
      <input type="radio" name="powerset" id="powersetEarth"       />Earth
      <input type="radio" name="powerset" id="powersetFire"        />Fire
      <input type="radio" name="powerset" id="powersetIce"         />Ice
    </td>
  </tr>
</table>
<br>
<hr>
<table>
  <tr>
    <td>
      <input type="checkbox" id="aliasCheckbox" onclick="javascript:createAlias();" />Make alias for character
    </td>
    <td>
      <select id="DropDownMenu_Alias" name="DropDownMenu_AliasName" onchange="javascript:setAlias();"></select>
    </td>
    <td>
      <input style="width: 400px;" name="aliasName" id="aliasID" type="text" />
    </td>
  </tr>
</table>
<br>
Make alias is for merging the data from characters with two different names (character was renamed using token).
<br>
The name in the bottom drop down menu will be removed and its data merged with main character name.
<br>
<br>
<!--
<hr>
<input type="checkbox" id="detailCheckbox" onclick="javascript:setDetail();" />Keep detailed information (Will take lots of memory and slow things down; use for small combat logs)
<br>
-->
<hr>
<br>
Click Export to construct an encoded string to save into a text file.
<br>
Save this file and you can import it at a later time which will be faster than loading the combat log again.
<br>
A window will pop up with the encoded text.  Right click on the white space and select Save As...
<br>
Use the import section below to import this file later.
<br>
<input id="exportButton" type="button" value="Export" onclick="javascript:exportData();" />
<br>
<br>
Import JSON document of combat log:
<br>
Will only import encoded data generated by the Export button above.
<br>
<table id="table0" width="100%">
 <tbody>
  <tr>
    <td>
       <p><input id="importFileID" name="importFileName" type="file"></p>
    </td>
    <td>
       <button style="visibility: hidden;" name="cancelbutton" id="cancelbutton" onclick="javascript:cancelReadFile();">Cancel read</button>
    </td>
  </tr>
  <tr>
    <td>
       <div id="progress_bar"><div class="percent">0%</div></div>
    </td>
  </tr>
 </tbody>
</table> 
<br>
<hr>
<br>
<input id="btn1" type="button" value="Submit Changes" onclick="javascript:return updateConfig();" />
<input id="quitbutton" value="Cancel" onclick="javascript:ExitProgram();" type="button">
<input id="helpButton" value="Help" onclick="javascript:helpMessageWindow();" type="button">

</form>

<script type="text/javascript">

// Utility function to add an event listener
function addEvent(o,e,f){
  if (o.addEventListener){ o.addEventListener(e,f,false); return true; }
  else if (o.attachEvent){ return o.attachEvent("on"+e,f); }
  else { return false; }
}

addEvent(window, "load", windowInit);

function windowInit() {

  if (window.opener.saveDetailedData == true) {
    if (document.getElementById('detailCheckbox') != null) {
      document.getElementById('detailCheckbox').checked = true;
    }
  } 

  // Hide the progress bar until import started
  document.getElementById('progress_bar').style.display="none";

  // Load the select drop down menu with characters this user plays
  loadDropDownMenu("DropDownMenu_Character");

  // Fill in the window's html elements with data from the string
  //   So fill in the proper radio button for movement mode if we
  //   have already stored it, else it will be blank
  fillData();
}

function loadDropDownMenu(dropDownID) {

  // Read the variable string from the parent window containing character data
  var tempObj = window.opener.readConfigUsers();

  // Convert into an array of character objects
  var arrayObjs = tempObj["Users"];

  // Fill in the drop down menu with all available character names
  var listbox = document.getElementById(dropDownID);

  for (var i = 0; i < arrayObjs.length; i++) {
    var selectBoxOption = document.createElement("option");
    selectBoxOption.value = arrayObjs[i].name;
    selectBoxOption.text = arrayObjs[i].name;
    listbox.add(selectBoxOption, null); 
  }
}

function ExitProgram() {
  window.close();
  self.close();
}


function helpMessageWindow() {
  var helpMessage = "This page allows to make changes to the data read in from combat logs\r\n";
  helpMessage += "You can manually set the mentor, movement mode, or powerset for playable characters.\r\n\r\n";
  helpMessage += "You can also merge two character's data.\r\n";
  helpMessage += "For example, if character1 was renamed to character1_BNW, you can merge these two into one.\r\n";
  helpMessage += "Simply select the current name in the top select box\r\n";
  helpMessage += "and then click the checkbox to make an alias.\r\n";
  helpMessage += "and then select the old character name from the drop down box next to alias.\r\n\r\n";
  helpMessage += "You can also export and import previously read in combat logs.\r\n";
  helpMessage += "Since combat logs can be quite large and slow to load, after loading, you can export\r\n";
  helpMessage += "the data and later import it and it will be faster than loading the same combat log again.\r\n";
  alert(helpMessage);
}

function updateConfig() {

  var tempObj = window.opener.readConfigUsers();
  var arrayObjs = tempObj["Users"];

  // Get character selected using GUI
  var x=document.getElementById("DropDownMenu_Character").selectedIndex;
  var y=document.getElementById("DropDownMenu_Character").options;

  if (typeof(y[x]) == "undefined") {
    // User did not select a character but clicked on Sumbit Changes
    // Maybe they did an export or import, just exit
    window.close();
    return false;
  }

  var person = y[x].text;

  var id = -1;

  // Figure out which object corresponds to that character
  for (var i = 0; i < arrayObjs.length; i++) {
    if (arrayObjs[i].name == person) { 
      id = i;
    }
  }

  // Update object with settings

  if (document.getElementById('mentorBatman').checked == true) {
    tempObj["Users"][id].mentor = "Batman";
    tempObj["Users"][id].faction = "Hero";
  }
  else if (document.getElementById('mentorSuperman').checked == true) {
    tempObj["Users"][id].mentor = "Superman";
    tempObj["Users"][id].faction = "Hero";
  }
  else if (document.getElementById('mentorWonderWoman').checked == true) {
    tempObj["Users"][id].mentor = "WonderWoman";
    tempObj["Users"][id].faction = "Hero";
  }
  else if (document.getElementById('mentorJoker').checked == true) {
    tempObj["Users"][id].mentor = "Joker";
    tempObj["Users"][id].faction = "Villain";
  }
  else if (document.getElementById('mentorLexLuthor').checked == true) {
    tempObj["Users"][id].mentor = "LexLuthor";
    tempObj["Users"][id].faction = "Villain";
  }
  else if (document.getElementById('mentorCirce').checked == true) {
    tempObj["Users"][id].mentor = "Circe";
    tempObj["Users"][id].faction = "Villain";
  }

  if (document.getElementById('movementAcrobatics').checked == true) {
    tempObj["Users"][id].movementmode = "Acrobatics";
  }
  else if (document.getElementById('movementFlight').checked == true) {
    tempObj["Users"][id].movementmode = "Flight";
  }
  else if (document.getElementById('movementSuperspeed').checked == true) {
    tempObj["Users"][id].movementmode = "Superspeed";
  }

  if (document.getElementById('powersetGadgets').checked == true) {
    tempObj["Users"][id].powerset = "Gadgets";
  }
  else if (document.getElementById('powersetMental').checked == true) {
    tempObj["Users"][id].powerset = "Mental";
  }
  else if (document.getElementById('powersetHardLight').checked == true) {
    tempObj["Users"][id].powerset = "Hard Light";
  }
  else if (document.getElementById('powersetElectric').checked == true) {
    tempObj["Users"][id].powerset = "Electric";
  }
  else if (document.getElementById('powersetNature').checked == true) {
    tempObj["Users"][id].powerset = "Nature";
  }
  else if (document.getElementById('powersetSorcery').checked == true) {
    tempObj["Users"][id].powerset = "Sorcery";
  }
  else if (document.getElementById('powersetEarth').checked == true) {
    tempObj["Users"][id].powerset = "Earth";
  }
  else if (document.getElementById('powersetFire').checked == true) {
    tempObj["Users"][id].powerset = "Fire";
  }
  else if (document.getElementById('powersetIce').checked == true) {
    tempObj["Users"][id].powerset = "Ice";
  }

  window.opener.writeConfigUsers(tempObj);
  window.opener.aliasMergeCharacters();
  window.close();
  return false;
}

function fillData() {

  // Obtain user configuration 
  var tempObj = window.opener.readConfigUsers();

  // Convert into an array of character objects
  var arrayObjs = tempObj["Users"];

  // Get character selected using GUI
  var x=document.getElementById("DropDownMenu_Character").selectedIndex;
  var y=document.getElementById("DropDownMenu_Character").options;
  var person = y[x].text;

  var id = -1;

  // Figure out which object corresponds to that character
  for (var i = 0; i < arrayObjs.length; i++) {
    if (arrayObjs[i].name == person) { 
      id = i;
    }
  }

  // Fill in other window elements like radio buttons

  // By default, set everything off, then selectively set on

  document.getElementById('mentorBatman').checked = false;
  document.getElementById('mentorSuperman').checked = false;
  document.getElementById('mentorWonderWoman').checked = false;
  document.getElementById('mentorJoker').checked = false;
  document.getElementById('mentorLexLuthor').checked = false;
  document.getElementById('mentorCirce').checked = false;
  document.getElementById('movementAcrobatics').checked = false;
  document.getElementById('movementFlight').checked = false;
  document.getElementById('movementSuperspeed').checked = false;
  document.getElementById('powersetGadgets').checked = false;
  document.getElementById('powersetMental').checked = false;
  document.getElementById('powersetHardLight').checked = false;
  document.getElementById('powersetElectric').checked = false;
  document.getElementById('powersetNature').checked = false;
  document.getElementById('powersetSorcery').checked = false;
  document.getElementById('powersetEarth').checked = false;
  document.getElementById('powersetFire').checked = false;
  document.getElementById('powersetIce').checked = false;

  if (arrayObjs[id].mentor == "Batman") {
    document.getElementById('mentorBatman').checked = true;
  }
  else if (arrayObjs[id].mentor == "Superman") {
    document.getElementById('mentorSuperman').checked = true;
  }
  else if (arrayObjs[id].mentor == "WonderWoman") {
    document.getElementById('mentorWonderWoman').checked = true;
  } 
  else if (arrayObjs[id].mentor == "Joker") {
    document.getElementById('mentorJoker').checked = true;
  }
  else if (arrayObjs[id].mentor == "LexLuthor") {
    document.getElementById('mentorLexLuthor').checked = true;
  }
  else if (arrayObjs[id].mentor == "Circe") {
    document.getElementById('mentorCirce').checked = true;
  }

  if (arrayObjs[id].movementmode == "Acrobatics") {
    document.getElementById('movementAcrobatics').checked = true;
  } 
  else if (arrayObjs[id].movementmode == "Flight") {
    document.getElementById('movementFlight').checked = true;
  }
  else if (arrayObjs[id].movementmode == "Superspeed") {
    document.getElementById('movementSuperspeed').checked = true;
  }

  if (arrayObjs[id].powerset == "Gadgets") {
    document.getElementById('powersetGadgets').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Mental") {
    document.getElementById('powersetMental').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Hard Light") {
    document.getElementById('powersetHardLight').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Electric") {
    document.getElementById('powersetElectric').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Nature") {
    document.getElementById('powersetNature').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Sorcery") {
    document.getElementById('powersetSorcery').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Earth") {
    document.getElementById('powersetEarth').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Fire") {
    document.getElementById('powersetFire').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Ice") {
    document.getElementById('powersetIce').checked = true;
  }
}

var aliasDropDownLoaded = 0;

function createAlias() {
  if (document.getElementById('aliasCheckbox').checked == true) {
    document.getElementById('DropDownMenu_Alias').style.display="block";
    if (aliasDropDownLoaded == 0) {
      loadDropDownMenu("DropDownMenu_Alias");
      aliasDropDownLoaded = 1;
    }
  }
  else {
    // Remove alias from variables

    // Get character selected using GUI
    var x=document.getElementById("DropDownMenu_Character").selectedIndex;
    var y=document.getElementById("DropDownMenu_Character").options;
    var person = y[x].text;
 
    var tempObj = window.opener.readConfigUsers();
    var arrayObjs = tempObj["Users"];
    var id = -1;

    // Figure out which object corresponds to that character
    for (var i = 0; i < arrayObjs.length; i++) {
      if (arrayObjs[i].name == person) { 
        id = i;
      }
    }

    // Update object with settings
    tempObj["Users"][id].alias = "";

    window.opener.writeConfigUsers(myVal);
  }
}

function setAlias() {
  // Get character selected using GUI
  var x=document.getElementById("DropDownMenu_Character").selectedIndex;
  var y=document.getElementById("DropDownMenu_Character").options;
  var person = y[x].text;

  // Get character selected using GUI
  x=document.getElementById("DropDownMenu_Alias").selectedIndex;
  y=document.getElementById("DropDownMenu_Alias").options;
  var alias = y[x].text;

  var aliasTBID = document.getElementById('aliasID');
  aliasTBID.value = "Make character " + alias + " the same as " + person;
  aliasTBID.style.display="block";

  var tempObj = window.opener.readConfigUsers();
  var arrayObjs = tempObj["Users"];
  var id = -1;

  // Figure out which object corresponds to that character
  for (var i = 0; i < arrayObjs.length; i++) {
    if (arrayObjs[i].name == person) { 
      id = i;
    }
  }

  // Update object with settings
  tempObj["Users"][id].alias = alias;

  window.opener.writeConfigUsers(tempObj);
}

// Call the parent window function to write all data to text file
function exportData() {
  window.opener.exportDataToFile();
  window.close();
}


var importFile = document.getElementById("importFileID");
var progress = document.querySelector('.percent');

var dataLoaded=false;
var dataLoadinProgress=false;
var chunkSize = 32768;
var dataJSONstring = "";

// If user presses the "Cancel Read" button, stop importing the file

function cancelReadFile() {
  dataLoadinProgress=false;
}


importFile.onchange = function (e) {

    e.preventDefault();

    if (dataLoadinProgress) {
      errorMessage = 'Another combat log is already loading...';
      alert(errorMessage);
      return false;
    }

    // Display the GUI element of the progress bar showing percent done
    document.getElementById('progress_bar').style.display="block";

    // Start with 0% done
    progress.style.width = '0%';
    progress.textContent = '0%';

    // "files" is a FileList (HTML5) of file objects.

    var file = importFile.files[0];

    function errorHandler(evt) {
      switch(evt.target.error.code) {
        case evt.target.error.NOT_FOUND_ERR:
          alert('File Not Found!');
          break;
        case evt.target.error.NOT_READABLE_ERR:
          alert('File is not readable');
          break;
        case evt.target.error.ABORT_ERR:
          break; // noop
        default:
          alert('An error occurred reading this file.');
       };
    }

    function abortRead() {
      reader.abort();
      dataLoaded = false;
      dataLoadinProgress=false;
      progress.style.width = '0%';
      progress.textContent = 'File load canceled';
      alert('File read cancelled');
    }

    dataLoadinProgress=true;
    document.getElementById('cancelbutton').style.visibility='visible'; // show

    var reader = new FileReader();

    reader.onerror = errorHandler;
    reader.onabort = abortRead;

    // If we use onloadend, we need to check the readyState.
    reader.onloadend = function(evt) {
      if (evt.target.readyState == FileReader.DONE) { // DONE == 2

        // Finished reading

        var success = window.opener.importDataFromFile(dataJSONstring);
        if (success != true) {
          alert("Invalid file for import.");
          progress.textContent = 'Error importing file';
        }
        else {
          progress.style.width = '100%';
          progress.textContent = 'File loaded: 100%';
        }

        // Set the dataLoaded boolean so we know we can start using data
        dataLoaded = true;
        dataLoadinProgress=false;

        document.getElementById('cancelbutton').style.visibility='hidden'; // hide
      }
    };

    reader.onloadstart = function(e) {
      document.getElementById('progress_bar').className = 'loading';
    };


    reader.onload = function (event) {

      if (dataLoadinProgress == false) {
        abortRead();
      }

      dataJSONstring += event.target.result; 

      var percentLoaded = Math.round((chunk / chunks) * 100);
      if (percentLoaded < 100) {
        progress.style.width = percentLoaded + '%';
        progress.textContent = "File loading: " + percentLoaded + '%';
      }

      if (++chunk <= chunks) {
        // console.info(chunk);
        loadNext(); // shortcut here
      }
    };

    var start = 0;
    var end = 0;
    var offset = 0;
    chunkSize = Math.ceil(file.size / 10000);
    if (chunkSize < 1024) { chunkSize = 1024; }


    // Will read the file in chunks starting with chunk 0
    var chunks = Math.ceil(file.size / chunkSize);
    var chunk = 0;

    // BLOB = (binary large object)

    function loadNext() {

      start = end - offset;
      end = start + chunkSize;
      if (end > file.size) { end = file.size; }

      if (file.mozSlice) {
        // Firefox implementation
        var blobSlice = file.mozSlice(start, end);
      } else if (file.webkitSlice) {
        // Chrome implementation
        var blobSlice = file.webkitSlice(start, end);
      } else {
        alert("Cannot use this browser"); return;
      }
      reader.readAsBinaryString(blobSlice);
    }

    loadNext();

  return false;
};


function setDetail() {
  var value = false;
  if (document.getElementById('detailCheckbox').checked == true) {
    value = true;
  }
  window.opener.setsaveDetailedData(value);
}

</script>
</body>
</html>
