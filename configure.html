<html>
<head>
<meta charset="utf-8">

<!--
//********************************************************************
//*  Description:   Creates a configuration web page for the user to 
//*     enter in information about characters that isn't gotten from 
//*     the combat.log file.  For example, what the character's mentor
//*     is.  We use this for determining what feats are available for 
//*     the character
//********************************************************************

// Copyright (c) 2011,2012 
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), 
// to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, 
// and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, 
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE 
// OR OTHER DEALINGS IN THE SOFTWARE.
-->


</head>
<body>

<style>
  #progress_bar {
    margin: 10px 0;
    padding: 3px;
    border: 1px solid #000;
    font-size: 14px;
    clear: both;
    opacity: 0;
    -moz-transition: opacity 1s linear;
    -o-transition: opacity 1s linear;
    -webkit-transition: opacity 1s linear;
  }
  #progress_bar.loading {
    opacity: 1.0;
  }
  #progress_bar .percent {
    background-color: #99ccff;
    height: auto;
    width: 0;
  }
  body {
	font-family: Verdana, Tahoma, Arial, Helvetica, sans-serif;
	font-size: .8em;
	}

  /* the div that holds the date picker calendar */
  .dpDiv {
  	}

  /* the table (within the div) that holds the date picker calendar */
  .dpTable {
	font-family: Tahoma, Arial, Helvetica, sans-serif;
	font-size: 12px;
	text-align: center;
	color: #505050;
	background-color: #ece9d8;
	border: 1px solid #AAAAAA;
	}

  /* a table row that holds date numbers (either blank or 1-31) */
  .dpTR {
	}

  /* the top table row that holds the month, year, and forward/backward buttons */
  .dpTitleTR {
  	}

  /* the second table row, that holds the names of days of the week (Mo, Tu, We, etc.) */
  .dpDayTR {
	}

  /* the bottom table row, that has the "This Month" and "Close" buttons */
  .dpTodayButtonTR {
	}

  /* a table cell that holds a date number (either blank or 1-31) */
  .dpTD {
	border: 1px solid #ece9d8;
	}

  /* a table cell that holds a highlighted day (usually either today's date or the current date field value) */
  .dpDayHighlightTD {
	background-color: #CCCCCC;
	border: 1px solid #AAAAAA;
	}

  /* the date number table cell that the mouse pointer is currently over (you can use contrasting colors to make it apparent which cell is being hovered over) */
  .dpTDHover {
	background-color: #aca998;
	border: 1px solid #888888;
	cursor: pointer;
	color: red;
	}

  /* the table cell that holds the name of the month and the year */
  .dpTitleTD {
	}

  /* a table cell that holds one of the forward/backward buttons */
  .dpButtonTD {
	}

  /* the table cell that holds the "This Month" or "Close" button at the bottom */
  .dpTodayButtonTD {
	}

  /* a table cell that holds the names of days of the week (Mo, Tu, We, etc.) */
  .dpDayTD {
	background-color: #CCCCCC;
	border: 1px solid #AAAAAA;
	color: white;
	}

  /* additional style information for the text that indicates the month and year */
  .dpTitleText {
	font-size: 12px;
	color: gray;
	font-weight: bold;
	}

  /* additional style information for the cell that holds a highlighted day (usually either today's date or the current date field value) */
  .dpDayHighlight {
	color: red;
	font-weight: bold;
	}

  /* the forward/backward buttons at the top */
  .dpButton {
	font-family: Verdana, Tahoma, Arial, Helvetica, sans-serif;
	font-size: 10px;
	color: gray;
	background: #d8e8ff;
	font-weight: bold;
	padding: 0px;
	}

  /* the "This Month" and "Close" buttons at the bottom */
  .dpTodayButton {
	font-family: Verdana, Tahoma, Arial, Helvetica, sans-serif;
	font-size: 10px;
	color: gray;
	background: #d8e8ff;
	font-weight: bold;
	}

</style>

<br>
<form>
For character:
<select id="DropDownMenu_Character" name="DropDownMenu_Character" onchange="javascript:fillData();"></select>
<br>
<table id="table0" width="100%">
  <tr>
    <td>
      Mentor:
    </td>
    <td>
      <input type="radio" name="mentor" id="mentorBatman"          />Batman
      <input type="radio" name="mentor" id="mentorSuperman"        />Superman
      <input type="radio" name="mentor" id="mentorWonderWoman"     />Wonder Woman
      <input type="radio" name="mentor" id="mentorJoker"           />Joker
      <input type="radio" name="mentor" id="mentorLexLuthor"       />Lex Luthor
      <input type="radio" name="mentor" id="mentorCirce"           />Circe
    </td>
  </tr>
  <tr>
    <td>
      Movement Mode:
    </td>
    <td>
      <input type="radio" name="movement" id="movementAcrobatics"  />Acrobatics
      <input type="radio" name="movement" id="movementFlight"      />Flight
      <input type="radio" name="movement" id="movementSuperspeed"  />Superspeed
    </td>
  </tr>
  <tr>
    <td>
      Powerset:
    </td>
    <td>
      <input type="radio" name="powerset" id="powersetGadgets"     />Gadgets
      <input type="radio" name="powerset" id="powersetMental"      />Mental
      <input type="radio" name="powerset" id="powersetHardLight"   />Hard Light
      <input type="radio" name="powerset" id="powersetElectric"    />Electric
      <input type="radio" name="powerset" id="powersetNature"      />Nature
      <input type="radio" name="powerset" id="powersetSorcery"     />Sorcery
      <input type="radio" name="powerset" id="powersetEarth"       />Earth
      <input type="radio" name="powerset" id="powersetFire"        />Fire
      <input type="radio" name="powerset" id="powersetIce"         />Ice
    </td>
  </tr>
</table>
<br>
<hr>
<table>
  <tr>
    <td>
      <input type="checkbox" id="aliasCheckbox" onclick="javascript:createAlias();" />Make alias for character
    </td>
    <td>
      <select id="DropDownMenu_Alias" name="DropDownMenu_AliasName" onchange="javascript:setAlias();"></select>
    </td>
    <td>
      <input style="width: 400px;" name="aliasName" id="aliasID" type="text" />
    </td>
  </tr>
</table>
<br>
Make alias is for merging the data from characters with two different names (character was renamed using token).
<br>
The name in the bottom drop down menu will be removed and its data merged with main character name.
<br>
<br>
<hr>
<br>
Click Export to construct an encoded string to save into a text file.
<br>
Save this file and you can import it at a later time which will be faster than loading the combat log again.
<br>
A window will pop up with the encoded text.  Right click on the white space and select Save As...
<br>
Use the import section below to import this file later.
<br>
<input id="exportButton" type="button" value="Export" onclick="javascript:exportData();" />
<br>
<br>
Import JSON document of combat log:
<br>
Will only import encoded data generated by the Export button above.
<br>
<table id="table0" width="100%">
 <tbody>
  <tr>
    <td>
       <p><input id="importFileID" name="importFileName" type="file"></p>
    </td>
    <td>
       <button style="visibility: hidden;" name="cancelbutton" id="cancelbutton" onclick="javascript:cancelReadFile();">Cancel read</button>
    </td>
  </tr>
  <tr>
    <td>
       <div id="progress_bar"><div class="percent">0%</div></div>
    </td>
  </tr>
 </tbody>
</table> 
<br>
<hr>
  <div>
  <table>
  <tr>
  <td>
  Log Scan Start Date: <input id="LSDate" name="LSDate" onclick="javascript:displayDatePicker('LSDate');">
  </td>
  <td>
  Log Scan Stop Date: <input id="LEDate" name="LEDate" onclick="javascript:displayDatePicker('LEDate');">
  </td>
  </tr>
  </table>
  </div>
<br>Only loads data in combat log after specified start date.  Specifying a more recent date loads less data but it will load faster.
<br>
<hr>
<input type="checkbox" id="detailCheckbox" onclick="javascript:setDetail();" />Keep detailed damage information
<br>Will take lots of memory and slow things down; use for small combat logs or choose recent date from above
<br>Usually at most one day of log data is possible or the browser crashes.
<br>
<hr>
<br>
<input id="btn1" type="button" value="Submit Changes" onclick="javascript:return updateConfig();" />
<input id="quitbutton" value="Cancel" onclick="javascript:ExitProgram();" type="button">
<input id="helpButton" value="Help" onclick="javascript:helpMessageWindow();" type="button">
<!-- input id="clearButton" value="Clear" onclick="javascript:window.opener.clearAllData();" type="button" -->

</form>

<script type="text/javascript">

// Utility function to add an event listener
function addEvent(o,e,f){
  if (o.addEventListener){ o.addEventListener(e,f,false); return true; }
  else if (o.attachEvent){ return o.attachEvent("on"+e,f); }
  else { return false; }
}

addEvent(window, "load", windowInit);

var timeNow = new Date();
var timezoneOffset = timeNow.getTimezoneOffset(); 

function windowInit() {

  if (window.opener.saveDetailedData == true) {
    if (document.getElementById('detailCheckbox') != null) {
      document.getElementById('detailCheckbox').checked = true;
    }
  } 

  // Hide the progress bar until import started
  document.getElementById('progress_bar').style.display="none";

  // If a timestamp was previously set by user, auto populate it into textbox
  var ts = window.opener.readTimestampStart();
  var te = window.opener.readTimestampEnd();

  document.getElementById('LSDate').value = convertTimestampToDateString(ts);
  document.getElementById('LEDate').value = convertTimestampToDateString(te);

  // Load the select drop down menu with characters this user plays
  loadDropDownMenu("DropDownMenu_Character");

  // Fill in the window's html elements with data from the string
  //   So fill in the proper radio button for movement mode if we
  //   have already stored it, else it will be blank
  fillData();
}

function loadDropDownMenu(dropDownID) {

  // Read the variable string from the parent window containing character data
  var tempObj = window.opener.readConfigUsers();

  // Convert into an array of character objects
  var arrayObjs = tempObj["Users"];

  // Fill in the drop down menu with all available character names
  var listbox = document.getElementById(dropDownID);

  for (var i = 0; i < arrayObjs.length; i++) {
    var selectBoxOption = document.createElement("option");
    selectBoxOption.value = arrayObjs[i].name;
    selectBoxOption.text = arrayObjs[i].name;
    listbox.add(selectBoxOption, null); 
  }
}

function ExitProgram() {
  window.close();
  self.close();
}

var VERSION = "6.3";

function helpMessageWindow() {
  var helpMessage = "";
  helpMessage += "DCUO Combat Log Data Analyzer\n";
  helpMessage += "   version " + VERSION + "\n\n";
  helpMessage += "This page allows to make changes to the data read in from combat logs\n";
  helpMessage += "You can manually set the mentor, movement mode, or powerset for playable characters.\n\n";
  helpMessage += "You can also merge two character's data.\n";
  helpMessage += "For example, if character1 was renamed to character1_BNW, you can merge these two into one.\n";
  helpMessage += "Simply select the current name in the top select box\n";
  helpMessage += "and then click the checkbox to make an alias.\n";
  helpMessage += "and then select the old character name from the drop down box next to alias.\n\n";
  helpMessage += "You can also export and import previously read in combat logs.\n";
  helpMessage += "Since combat logs can be quite large and slow to load, after loading, you can export\n";
  helpMessage += "the data and later import it and it will be faster than loading the same combat log again.\n";
  alert(helpMessage);
}

function updateConfig() {

  var tempObj = window.opener.readConfigUsers();
  var arrayObjs = tempObj["Users"];

  var startDateString = document.getElementById("LSDate").value;
  if (startDateString == "") {
    var startStr = new Date("December 20, 2010 01:00:00");
    startDateString = convertDateObjectToDateString(startStr);
  }
  var startTS = convertDateStringToTimestamp(startDateString);
  window.opener.saveTimestampStart(startTS);
  var endDateString = document.getElementById("LEDate").value;
  if (endDateString == "") {
    var endStr = new Date();
    endDateString = convertDateObjectToDateString(endStr);
  }
  var endTS = convertDateStringToTimestamp(endDateString);
  window.opener.saveTimestampEnd(endTS);

  // Get character selected using GUI
  var x=document.getElementById("DropDownMenu_Character").selectedIndex;
  var y=document.getElementById("DropDownMenu_Character").options;

  if (typeof(y[x]) == "undefined") {
    // User did not select a character but clicked on Submit Changes
    // Maybe they did an export or import, just exit
    window.close();
    return false;
  }

  var person = y[x].text;

  var id = -1;

  // Figure out which object corresponds to that character
  for (var i = 0; i < arrayObjs.length; i++) {
    if (arrayObjs[i].name == person) { 
      id = i;
    }
  }

  // Update object with settings

  if (document.getElementById('mentorBatman').checked == true) {
    tempObj["Users"][id].mentor = "Batman";
    tempObj["Users"][id].faction = "Hero";
  }
  else if (document.getElementById('mentorSuperman').checked == true) {
    tempObj["Users"][id].mentor = "Superman";
    tempObj["Users"][id].faction = "Hero";
  }
  else if (document.getElementById('mentorWonderWoman').checked == true) {
    tempObj["Users"][id].mentor = "WonderWoman";
    tempObj["Users"][id].faction = "Hero";
  }
  else if (document.getElementById('mentorJoker').checked == true) {
    tempObj["Users"][id].mentor = "Joker";
    tempObj["Users"][id].faction = "Villain";
  }
  else if (document.getElementById('mentorLexLuthor').checked == true) {
    tempObj["Users"][id].mentor = "LexLuthor";
    tempObj["Users"][id].faction = "Villain";
  }
  else if (document.getElementById('mentorCirce').checked == true) {
    tempObj["Users"][id].mentor = "Circe";
    tempObj["Users"][id].faction = "Villain";
  }

  if (document.getElementById('movementAcrobatics').checked == true) {
    tempObj["Users"][id].movementmode = "Acrobatics";
  }
  else if (document.getElementById('movementFlight').checked == true) {
    tempObj["Users"][id].movementmode = "Flight";
  }
  else if (document.getElementById('movementSuperspeed').checked == true) {
    tempObj["Users"][id].movementmode = "Superspeed";
  }

  if (document.getElementById('powersetGadgets').checked == true) {
    tempObj["Users"][id].powerset = "Gadgets";
  }
  else if (document.getElementById('powersetMental').checked == true) {
    tempObj["Users"][id].powerset = "Mental";
  }
  else if (document.getElementById('powersetHardLight').checked == true) {
    tempObj["Users"][id].powerset = "Hard Light";
  }
  else if (document.getElementById('powersetElectric').checked == true) {
    tempObj["Users"][id].powerset = "Electric";
  }
  else if (document.getElementById('powersetNature').checked == true) {
    tempObj["Users"][id].powerset = "Nature";
  }
  else if (document.getElementById('powersetSorcery').checked == true) {
    tempObj["Users"][id].powerset = "Sorcery";
  }
  else if (document.getElementById('powersetEarth').checked == true) {
    tempObj["Users"][id].powerset = "Earth";
  }
  else if (document.getElementById('powersetFire').checked == true) {
    tempObj["Users"][id].powerset = "Fire";
  }
  else if (document.getElementById('powersetIce').checked == true) {
    tempObj["Users"][id].powerset = "Ice";
  }

  window.opener.writeConfigUsers(tempObj);
  window.opener.aliasMergeCharacters();
  window.close();
  return false;
}

function fillData() {

  // Obtain user configuration 
  var tempObj = window.opener.readConfigUsers();

  // Convert into an array of character objects
  var arrayObjs = tempObj["Users"];

  // Get character selected using GUI
  var x=document.getElementById("DropDownMenu_Character").selectedIndex;
  var y=document.getElementById("DropDownMenu_Character").options;
  var person = y[x].text;

  var id = -1;

  // Figure out which object corresponds to that character
  for (var i = 0; i < arrayObjs.length; i++) {
    if (arrayObjs[i].name == person) { 
      id = i;
    }
  }

  // Fill in other window elements like radio buttons

  // By default, set everything off, then selectively set on

  document.getElementById('mentorBatman').checked = false;
  document.getElementById('mentorSuperman').checked = false;
  document.getElementById('mentorWonderWoman').checked = false;
  document.getElementById('mentorJoker').checked = false;
  document.getElementById('mentorLexLuthor').checked = false;
  document.getElementById('mentorCirce').checked = false;
  document.getElementById('movementAcrobatics').checked = false;
  document.getElementById('movementFlight').checked = false;
  document.getElementById('movementSuperspeed').checked = false;
  document.getElementById('powersetGadgets').checked = false;
  document.getElementById('powersetMental').checked = false;
  document.getElementById('powersetHardLight').checked = false;
  document.getElementById('powersetElectric').checked = false;
  document.getElementById('powersetNature').checked = false;
  document.getElementById('powersetSorcery').checked = false;
  document.getElementById('powersetEarth').checked = false;
  document.getElementById('powersetFire').checked = false;
  document.getElementById('powersetIce').checked = false;

  if (arrayObjs[id].mentor == "Batman") {
    document.getElementById('mentorBatman').checked = true;
  }
  else if (arrayObjs[id].mentor == "Superman") {
    document.getElementById('mentorSuperman').checked = true;
  }
  else if (arrayObjs[id].mentor == "WonderWoman") {
    document.getElementById('mentorWonderWoman').checked = true;
  } 
  else if (arrayObjs[id].mentor == "Joker") {
    document.getElementById('mentorJoker').checked = true;
  }
  else if (arrayObjs[id].mentor == "LexLuthor") {
    document.getElementById('mentorLexLuthor').checked = true;
  }
  else if (arrayObjs[id].mentor == "Circe") {
    document.getElementById('mentorCirce').checked = true;
  }

  if (arrayObjs[id].movementmode == "Acrobatics") {
    document.getElementById('movementAcrobatics').checked = true;
  } 
  else if (arrayObjs[id].movementmode == "Flight") {
    document.getElementById('movementFlight').checked = true;
  }
  else if (arrayObjs[id].movementmode == "Superspeed") {
    document.getElementById('movementSuperspeed').checked = true;
  }

  if (arrayObjs[id].powerset == "Gadgets") {
    document.getElementById('powersetGadgets').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Mental") {
    document.getElementById('powersetMental').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Hard Light") {
    document.getElementById('powersetHardLight').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Electric") {
    document.getElementById('powersetElectric').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Nature") {
    document.getElementById('powersetNature').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Sorcery") {
    document.getElementById('powersetSorcery').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Earth") {
    document.getElementById('powersetEarth').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Fire") {
    document.getElementById('powersetFire').checked = true;
  } 
  else if (arrayObjs[id].powerset == "Ice") {
    document.getElementById('powersetIce').checked = true;
  }
}

var aliasDropDownLoaded = 0;

function createAlias() {
  if (document.getElementById('aliasCheckbox').checked == true) {
    document.getElementById('DropDownMenu_Alias').style.display="block";
    if (aliasDropDownLoaded == 0) {
      loadDropDownMenu("DropDownMenu_Alias");
      aliasDropDownLoaded = 1;
    }
  }
  else {
    // Remove alias from variables

    // Get character selected using GUI
    var x=document.getElementById("DropDownMenu_Character").selectedIndex;
    var y=document.getElementById("DropDownMenu_Character").options;
    var person = y[x].text;
 
    var tempObj = window.opener.readConfigUsers();
    var arrayObjs = tempObj["Users"];
    var id = -1;

    // Figure out which object corresponds to that character
    for (var i = 0; i < arrayObjs.length; i++) {
      if (arrayObjs[i].name == person) { 
        id = i;
      }
    }

    // Update object with settings
    tempObj["Users"][id].alias = "";

    window.opener.writeConfigUsers(myVal);
  }
}

function setAlias() {
  // Get character selected using GUI
  var x=document.getElementById("DropDownMenu_Character").selectedIndex;
  var y=document.getElementById("DropDownMenu_Character").options;
  var person = y[x].text;

  // Get character selected using GUI
  x=document.getElementById("DropDownMenu_Alias").selectedIndex;
  y=document.getElementById("DropDownMenu_Alias").options;
  var alias = y[x].text;

  var aliasTBID = document.getElementById('aliasID');
  aliasTBID.value = "Make character " + alias + " the same as " + person;
  aliasTBID.style.display="block";

  var tempObj = window.opener.readConfigUsers();
  var arrayObjs = tempObj["Users"];
  var id = -1;

  // Figure out which object corresponds to that character
  for (var i = 0; i < arrayObjs.length; i++) {
    if (arrayObjs[i].name == person) { 
      id = i;
    }
  }

  // Update object with settings
  tempObj["Users"][id].alias = alias;

  window.opener.writeConfigUsers(tempObj);
}

// Call the parent window function to write all data to text file
function exportData() {
  window.opener.exportDataToFile();
  window.close();
}


var importFile = document.getElementById("importFileID");
var progress = document.querySelector('.percent');

var dataLoaded=false;
var dataLoadinProgress=false;
var chunkSize = 32768;
var dataJSONstring = "";

// If user presses the "Cancel Read" button, stop importing the file

function cancelReadFile() {
  dataLoadinProgress=false;
}


importFile.onchange = function (e) {

    e.preventDefault();

    if (dataLoadinProgress) {
      errorMessage = 'Another combat log is already loading...';
      alert(errorMessage);
      return false;
    }

    // Display the GUI element of the progress bar showing percent done
    document.getElementById('progress_bar').style.display="block";

    // Start with 0% done
    progress.style.width = '0%';
    progress.textContent = '0%';

    // "files" is a FileList (HTML5) of file objects.

    var file = importFile.files[0];

    function errorHandler(evt) {
      switch(evt.target.error.code) {
        case evt.target.error.NOT_FOUND_ERR:
          alert('File Not Found!');
          break;
        case evt.target.error.NOT_READABLE_ERR:
          alert('File is not readable');
          break;
        case evt.target.error.ABORT_ERR:
          break; // noop
        default:
          alert('An error occurred reading this file.');
       };
    }

    function abortRead() {
      reader.abort();
      dataLoaded = false;
      dataLoadinProgress=false;
      progress.style.width = '0%';
      progress.textContent = 'File load canceled';
      alert('File read cancelled');
    }

    dataLoadinProgress=true;
    document.getElementById('cancelbutton').style.visibility='visible'; // show

    var reader = new FileReader();

    reader.onerror = errorHandler;
    reader.onabort = abortRead;

    // If we use onloadend, we need to check the readyState.
    reader.onloadend = function(evt) {
      if (evt.target.readyState == FileReader.DONE) { // DONE == 2

        // Finished reading

        var success = window.opener.importDataFromFile(dataJSONstring);
        if (success != true) {
          alert("Invalid file for import.");
          progress.textContent = 'Error importing file';
        }
        else {
          progress.style.width = '100%';
          progress.textContent = 'File loaded: 100%';
        }

        // Set the dataLoaded boolean so we know we can start using data
        dataLoaded = true;
        dataLoadinProgress=false;

        document.getElementById('cancelbutton').style.visibility='hidden'; // hide
      }
    };

    reader.onloadstart = function(e) {
      document.getElementById('progress_bar').className = 'loading';
    };


    reader.onload = function (event) {

      if (dataLoadinProgress == false) {
        abortRead();
      }

      dataJSONstring += event.target.result; 

      var percentLoaded = Math.round((chunk / chunks) * 100);
      if (percentLoaded < 100) {
        progress.style.width = percentLoaded + '%';
        progress.textContent = "File loading: " + percentLoaded + '%';
      }

      if (++chunk <= chunks) {
        // console.info(chunk);
        loadNext(); // shortcut here
      }
    };

    var start = 0;
    var end = 0;
    var offset = 0;
    chunkSize = Math.ceil(file.size / 10000);
    if (chunkSize < 1024) { chunkSize = 1024; }


    // Will read the file in chunks starting with chunk 0
    var chunks = Math.ceil(file.size / chunkSize);
    var chunk = 0;

    // BLOB = (binary large object)

    function loadNext() {

      start = end - offset;
      end = start + chunkSize;
      if (end > file.size) { end = file.size; }

      if (file.mozSlice) {
        // Firefox implementation
        var blobSlice = file.mozSlice(start, end);
      } else if (file.webkitSlice) {
        // Chrome implementation
        var blobSlice = file.webkitSlice(start, end);
      } else {
        alert("Cannot use this browser"); return;
      }
      reader.readAsBinaryString(blobSlice);
    }

    loadNext();

  return false;
};


function setDetail() {
  var value = false;
  if (document.getElementById('detailCheckbox').checked == true) {
    value = true;
  }
  window.opener.setsaveDetailedData(value);
}


// ********************************************************************
// *	convertDateStringToTimestamp
// *	Function that takes in a Date string and returns the unix timestamp
// ********************************************************************

function convertDateStringToTimestamp(dateStr)
{
  // If the date string does not contain a slash "/:, then assume it is
  //   already a timestamp

  if (dateStr.indexOf("/") < 0) {
    timestamp = parseFloat(dateStr);
    return timestamp;
  }
  // Have to include the radix of 10 as second param to parseint for leading 0 numbers like "01"
  var month = parseInt(dateStr.substring(0, 2), 10) - 1;
  var day   = parseInt(dateStr.substring(3, 5), 10);
  var year  = parseInt(dateStr.substring(6, 10));
  var myDate = new Date();
  var timestamp = Math.round(myDate.setFullYear(year,month,day) / 1000);

  return timestamp + timezoneOffset;
};


function convertDateObjectToDateString(dateObj)
{
  var monthStr = "";
  var dayStr = "";
  var yearStr = "";
  var dateStr = "";

  var month = dateObj.getMonth() + 1;
  if (month < 10) { monthStr = "0" + month.toString(); }
  else { monthStr = month.toString(); }

  var day = dateObj.getDate();
  if (day < 10) { dayStr = "0" + day.toString(); }
  else { dayStr = day.toString(); }

  var yearStr = dateObj.getFullYear();

  dateStr = monthStr + "/" + dayStr + "/" + yearStr;
  return dateStr;
};


function convertTimestampToDateString(tstamp)
{
  var ts = parseInt(tstamp);
  var myDate = new Date();
  myDate.setTime((ts + timezoneOffset) * 1000);
  return convertDateObjectToDateString(myDate);
};


/**
This is a JavaScript library that will allow you to easily add some basic DHTML
drop-down datepicker functionality to your Notes forms. This script is not as
full-featured as others you may find on the Internet, but it's free, it's easy to
understand, and it's easy to change.

You'll also want to include a stylesheet that makes the datepicker elements
look nice. An example one can be found in the database that this script was
originally released with, at:

http://www.nsftools.com/tips/NotesTips.htm#datepicker

I've tested this lightly with Internet Explorer 6 and Mozilla Firefox. I have no idea
how compatible it is with other browsers.

version 1.5
December 4, 2005
Julian Robichaux -- http://www.nsftools.com

HISTORY
--  version 1.0 (Sept. 4, 2004):
Initial release.

--  version 1.1 (Sept. 5, 2004):
Added capability to define the date format to be used, either globally (using the
defaultDateSeparator and defaultDateFormat variables) or when the displayDatePicker
function is called.

--  version 1.2 (Sept. 7, 2004):
Fixed problem where datepicker x-y coordinates weren't right inside of a table.
Fixed problem where datepicker wouldn't display over selection lists on a page.
Added a call to the datePickerClosed function (if one exists) after the datepicker
is closed, to allow the developer to add their own custom validation after a date
has been chosen. For this to work, you must have a function called datePickerClosed
somewhere on the page, that accepts a field object as a parameter. See the
example in the comments of the updateDateField function for more details.

--  version 1.3 (Sept. 9, 2004)
Fixed problem where adding the <div> and <iFrame> used for displaying the datepicker
was causing problems on IE 6 with global variables that had handles to objects on
the page (I fixed the problem by adding the elements using document.createElement()
and document.body.appendChild() instead of document.body.innerHTML += ...).

--  version 1.4 (Dec. 20, 2004)
Added "targetDateField.focus();" to the updateDateField function (as suggested
by Alan Lepofsky) to avoid a situation where the cursor focus is at the top of the
form after a date has been picked. Added "padding: 0px;" to the dpButton CSS
style, to keep the table from being so wide when displayed in Firefox.

-- version 1.5 (Dec 4, 2005)
Added display=none when datepicker is hidden, to fix problem where cursor is
not visible on input fields that are beneath the date picker. Added additional null
date handling for date errors in Safari when the date is empty. Added additional
error handling for iFrame creation, to avoid reported errors in Opera. Added
onMouseOver event for day cells, to allow color changes when the mouse hovers
over a cell (to make it easier to determine what cell you're over). Added comments
in the style sheet, to make it more clear what the different style elements are for.
*/

var datePickerDivID = "datepicker";
var iFrameDivID = "datepickeriframe";

var dayArrayShort = new Array('Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa');
var dayArrayMed = new Array('Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat');
var dayArrayLong = new Array('Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday');
var monthArrayShort = new Array('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec');
var monthArrayMed = new Array('Jan', 'Feb', 'Mar', 'Apr', 'May', 'June', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec');
var monthArrayLong = new Array('January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December');

// these variables define the date formatting we're expecting and outputting.
// If you want to use a different format by default, change the defaultDateSeparator
// and defaultDateFormat variables either here or on your HTML page.
var defaultDateSeparator = "/";        // common values would be "/" or "."
var defaultDateFormat = "mdy"    // valid values are "mdy", "dmy", and "ymd"
var dateSeparator = defaultDateSeparator;
var dateFormat = defaultDateFormat;

/**
This is the main function you'll call from the onClick event of a button.
Normally, you'll have something like this on your HTML page:

Start Date: <input name="StartDate">
<input type=button value="select" onclick="displayDatePicker('StartDate');">

That will cause the datepicker to be displayed beneath the StartDate field and
any date that is chosen will update the value of that field. If you'd rather have the
datepicker display beneath the button that was clicked, you can code the button
like this:

<input type=button value="select" onclick="displayDatePicker('StartDate', this);">

So, pretty much, the first argument (dateFieldName) is a string representing the
name of the field that will be modified if the user picks a date, and the second
argument (displayBelowThisObject) is optional and represents an actual node
on the HTML document that the datepicker should be displayed below.

In version 1.1 of this code, the dtFormat and dtSep variables were added, allowing
you to use a specific date format or date separator for a given call to this function.
Normally, you'll just want to set these defaults globally with the defaultDateSeparator
and defaultDateFormat variables, but it doesn't hurt anything to add them as optional
parameters here. An example of use is:

<input type=button value="select" onclick="displayDatePicker('StartDate', false, 'dmy', '.');">

This would display the datepicker beneath the StartDate field (because the
displayBelowThisObject parameter was false), and update the StartDate field with
the chosen value of the datepicker using a date format of dd.mm.yyyy
*/

function displayDatePicker(dateFieldName, displayBelowThisObject, dtFormat, dtSep)
{
  var targetDateField = document.getElementsByName (dateFieldName).item(0);

  // if we weren't told what node to display the datepicker beneath, just display it
  // beneath the date field we're updating
  if (!displayBelowThisObject)
    displayBelowThisObject = targetDateField;

  // if a date separator character was given, update the dateSeparator variable
  if (dtSep)
    dateSeparator = dtSep;
  else
    dateSeparator = defaultDateSeparator;

  // if a date format was given, update the dateFormat variable
  if (dtFormat)
    dateFormat = dtFormat;
  else
    dateFormat = defaultDateFormat;

  var x = displayBelowThisObject.offsetLeft;
  var y = displayBelowThisObject.offsetTop + displayBelowThisObject.offsetHeight ;

  // deal with elements inside tables and such
  var parent = displayBelowThisObject;
  while (parent.offsetParent) {
    parent = parent.offsetParent;
    x += parent.offsetLeft;
    y += parent.offsetTop ;
  }

  drawDatePicker(targetDateField, x, y);
}


/**
Draw the datepicker object (which is just a table with calendar elements) at the
specified x and y coordinates, using the targetDateField object as the input tag
that will ultimately be populated with a date.

This function will normally be called by the displayDatePicker function.
*/
function drawDatePicker(targetDateField, x, y)
{
  var dt = getFieldDate(targetDateField.value );

  // the datepicker table will be drawn inside of a <div> with an ID defined by the
  // global datePickerDivID variable. If such a div doesn't yet exist on the HTML
  // document we're working with, add one.
  if (!document.getElementById(datePickerDivID)) {
    // don't use innerHTML to update the body, because it can cause global variables
    // that are currently pointing to objects on the page to have bad references
    //document.body.innerHTML += "<div id='" + datePickerDivID + "' class='dpDiv'></div>";
    var newNode = document.createElement("div");
    newNode.setAttribute("id", datePickerDivID);
    newNode.setAttribute("class", "dpDiv");
    newNode.setAttribute("style:", "visibility: hidden;");
    document.body.appendChild(newNode);
  }

  // move the datepicker div to the proper x,y coordinate and toggle the visiblity
  var pickerDiv = document.getElementById(datePickerDivID);
  pickerDiv.style.position = "absolute";
  pickerDiv.style.left = x + "px";
  pickerDiv.style.top = y + "px";
  pickerDiv.style.visibility = (pickerDiv.style.visibility == "visible" ? "hidden" : "visible");
  pickerDiv.style.display = (pickerDiv.style.display == "block" ? "none" : "block");
  pickerDiv.style.zIndex = 10000;

  // draw the datepicker table
  refreshDatePicker(targetDateField.name, dt.getFullYear(), dt.getMonth(), dt.getDate());
}


/**
This is the function that actually draws the datepicker calendar.
*/
function refreshDatePicker(dateFieldName, year, month, day)
{
  // if no arguments are passed, use today's date; otherwise, month and year
  // are required (if a day is passed, it will be highlighted later)
  var thisDay = new Date();

  if ((month >= 0) && (year > 0)) {
    thisDay = new Date(year, month, 1);
  } else {
    day = thisDay.getDate();
    thisDay.setDate(1);
  }

  // the calendar will be drawn as a table
  // you can customize the table elements with a global CSS style sheet,
  // or by hardcoding style and formatting elements below
  var crlf = "\r\n";
  var TABLE = "<table cols=7 class='dpTable'>" + crlf;
  var xTABLE = "</table>" + crlf;
  var TR = "<tr class='dpTR'>";
  var TR_title = "<tr class='dpTitleTR'>";
  var TR_days = "<tr class='dpDayTR'>";
  var TR_todaybutton = "<tr class='dpTodayButtonTR'>";
  var xTR = "</tr>" + crlf;
  var TD = "<td class='dpTD' onMouseOut='this.className=\"dpTD\";' onMouseOver=' this.className=\"dpTDHover\";' ";    // leave this tag open, because we'll be adding an onClick event
  var TD_title = "<td colspan=5 class='dpTitleTD'>";
  var TD_buttons = "<td class='dpButtonTD'>";
  var TD_todaybutton = "<td colspan=7 class='dpTodayButtonTD'>";
  var TD_days = "<td class='dpDayTD'>";
  var TD_selected = "<td class='dpDayHighlightTD' onMouseOut='this.className=\"dpDayHighlightTD\";' onMouseOver='this.className=\"dpTDHover\";' ";    // leave this tag open, because we'll be adding an onClick event
  var xTD = "</td>" + crlf;
  var DIV_title = "<div class='dpTitleText'>";
  var DIV_selected = "<div class='dpDayHighlight'>";
  var xDIV = "</div>";
  var i = 0;

  // start generating the code for the calendar table
  var html = TABLE;

  // this is the title bar, which displays the month and the buttons to
  // go back to a previous month or forward to the next month
  html += TR_title;
  html += TD_buttons + getButtonCode(dateFieldName, thisDay, -1, "&lt;") + xTD;
  html += TD_title + DIV_title + monthArrayLong[ thisDay.getMonth()] + " " + thisDay.getFullYear() + xDIV + xTD;
  html += TD_buttons + getButtonCode(dateFieldName, thisDay, 1, "&gt;") + xTD;
  html += xTR;

  // this is the row that indicates which day of the week we're on
  html += TR_days;
  for(i = 0; i < dayArrayShort.length; i++)
    html += TD_days + dayArrayShort[i] + xTD;
  html += xTR;

  // now we'll start populating the table with days of the month
  html += TR;

  // first, the leading blanks
  for (i = 0; i < thisDay.getDay(); i++)
    html += TD + "&nbsp;" + xTD;

  // now, the days of the month
  do {
    var dayNum = thisDay.getDate();
    var TD_onclick = " onclick=\"updateDateField('" + dateFieldName + "', '" + getDateString(thisDay) + "');\">";

    if (dayNum == day)
      html += TD_selected + TD_onclick + DIV_selected + dayNum + xDIV + xTD;
    else
      html += TD + TD_onclick + dayNum + xTD;

    // if this is a Saturday, start a new row
    if (thisDay.getDay() == 6)
      html += xTR + TR;

    // increment the day
    thisDay.setDate(thisDay.getDate() + 1);
  } while (thisDay.getDate() > 1)

  // fill in any trailing blanks
  if (thisDay.getDay() > 0) {
    for (i = 6; i > thisDay.getDay(); i--)
      html += TD + "&nbsp;" + xTD;
  }
  html += xTR;

  // add a button to allow the user to easily return to today, or close the calendar
  var today = new Date();
  var todayString = "Today is " + dayArrayMed[today.getDay()] + ", " + monthArrayMed[ today.getMonth()] + " " + today.getDate();
  html += TR_todaybutton + TD_todaybutton;
  html += "<button class='dpTodayButton' onClick='refreshDatePicker(\"" + dateFieldName + "\");'>this month</button> ";
  html += "<button class='dpTodayButton' onClick='updateDateField(\"" + dateFieldName + "\");'>close</button>";
  html += xTD + xTR;

  // and finally, close the table
  html += xTABLE;

  document.getElementById(datePickerDivID).innerHTML = html;
  // add an "iFrame shim" to allow the datepicker to display above selection lists
  adjustiFrame();
}


/**
Convenience function for writing the code for the buttons that bring us back or forward
a month.
*/
function getButtonCode(dateFieldName, dateVal, adjust, label)
{
  var newMonth = (dateVal.getMonth () + adjust) % 12;
  var newYear = dateVal.getFullYear() + parseInt((dateVal.getMonth() + adjust) / 12);
  if (newMonth < 0) {
    newMonth += 12;
    newYear += -1;
  }

  return "<button class='dpButton' onClick='refreshDatePicker(\"" + dateFieldName + "\", " + newYear + ", " + newMonth + ");'>" + label + "</button>";
}


/**
Convert a JavaScript Date object to a string, based on the dateFormat and dateSeparator
variables at the beginning of this script library.
*/
function getDateString(dateVal)
{
  var dayString = "00" + dateVal.getDate();
  var monthString = "00" + (dateVal.getMonth()+1);
  dayString = dayString.substring(dayString.length - 2);
  monthString = monthString.substring(monthString.length - 2);

  switch (dateFormat) {
    case "dmy" :
      return dayString + dateSeparator + monthString + dateSeparator + dateVal.getFullYear();
    case "ymd" :
      return dateVal.getFullYear() + dateSeparator + monthString + dateSeparator + dayString;
    case "mdy" :
    default :
      return monthString + dateSeparator + dayString + dateSeparator + dateVal.getFullYear();
  }
}


/**
Convert a string to a JavaScript Date object.
*/
function getFieldDate(dateString)
{
  var dateVal;
  var dArray;
  var d, m, y;

  try {
    dArray = splitDateString(dateString);
    if (dArray) {
      switch (dateFormat) {
        case "dmy" :
          d = parseInt(dArray[0], 10);
          m = parseInt(dArray[1], 10) - 1;
          y = parseInt(dArray[2], 10);
          break;
        case "ymd" :
          d = parseInt(dArray[2], 10);
          m = parseInt(dArray[1], 10) - 1;
          y = parseInt(dArray[0], 10);
          break;
        case "mdy" :
        default :
          d = parseInt(dArray[1], 10);
          m = parseInt(dArray[0], 10) - 1;
          y = parseInt(dArray[2], 10);
          break;
      }
      dateVal = new Date(y, m, d);
    } else if (dateString) {
      dateVal = new Date(dateString);
    } else {
      dateVal = new Date();
    }
  } catch(e) {
    dateVal = new Date();
  }

  return dateVal;
}


/**
Try to split a date string into an array of elements, using common date separators.
If the date is split, an array is returned; otherwise, we just return false.
*/
function splitDateString(dateString)
{
  var dArray;
  if (dateString.indexOf("/") >= 0)
    dArray = dateString.split("/");
  else if (dateString.indexOf(".") >= 0)
    dArray = dateString.split(".");
  else if (dateString.indexOf("-") >= 0)
    dArray = dateString.split("-");
  else if (dateString.indexOf("\\") >= 0)
    dArray = dateString.split("\\");
  else
    dArray = false;

  return dArray;
}

/**
Update the field with the given dateFieldName with the dateString that has been passed,
and hide the datepicker. If no dateString is passed, just close the datepicker without
changing the field value.

Also, if the page developer has defined a function called datePickerClosed anywhere on
the page or in an imported library, we will attempt to run that function with the updated
field as a parameter. This can be used for such things as date validation, setting default
values for related fields, etc. For example, you might have a function like this to validate
a start date field:

function datePickerClosed(dateField)
{
  var dateObj = getFieldDate(dateField.value);
  var today = new Date();
  today = new Date(today.getFullYear(), today.getMonth(), today.getDate());

  if (dateField.name == "StartDate") {
    if (dateObj < today) {
      // if the date is before today, alert the user and display the datepicker again
      alert("Please enter a date that is today or later");
      dateField.value = "";
      document.getElementById(datePickerDivID).style.visibility = "visible";
      adjustiFrame();
    } else {
      // if the date is okay, set the EndDate field to 7 days after the StartDate
      dateObj.setTime(dateObj.getTime() + (7 * 24 * 60 * 60 * 1000));
      var endDateField = document.getElementsByName ("EndDate").item(0);
      endDateField.value = getDateString(dateObj);
    }
  }
}

*/
function updateDateField(dateFieldName, dateString)
{
  var targetDateField = document.getElementsByName (dateFieldName).item(0);
  if (dateString)
    targetDateField.value = dateString;

  var pickerDiv = document.getElementById(datePickerDivID);
  pickerDiv.style.visibility = "hidden";
  pickerDiv.style.display = "none";

  adjustiFrame();
  targetDateField.focus();

  // after the datepicker has closed, optionally run a user-defined function called
  // datePickerClosed, passing the field that was just updated as a parameter
  // (note that this will only run if the user actually selected a date from the datepicker)
  if ((dateString) && (typeof(datePickerClosed) == "function"))
    datePickerClosed(targetDateField);
  dataOptionExecute();
}


/**
Use an "iFrame shim" to deal with problems where the datepicker shows up behind
selection list elements, if they're below the datepicker. The problem and solution are
described at:

http://dotnetjunkies.com/WebLog/jking/archive/2003/07/21/488.aspx
http://dotnetjunkies.com/WebLog/jking/archive/2003/10/30/2975.aspx
*/
function adjustiFrame(pickerDiv, iFrameDiv)
{
  // we know that Opera doesn't like something about this, so if we
  // think we're using Opera, don't even try
  var is_opera = (navigator.userAgent.toLowerCase().indexOf("opera") != -1);
  if (is_opera)
    return;

  // put a try/catch block around the whole thing, just in case
  try {
    if (!document.getElementById(iFrameDivID)) {
      // don't use innerHTML to update the body, because it can cause global variables
      // that are currently pointing to objects on the page to have bad references
      //document.body.innerHTML += "<iframe id='" + iFrameDivID + "' src='javascript:false;' scrolling='no' frameborder='0'>";
      var newNode = document.createElement("iFrame");
      newNode.setAttribute("id", iFrameDivID);
      newNode.setAttribute("src", "javascript:false;");
      newNode.setAttribute("scrolling", "no");
      newNode.setAttribute ("frameborder", "0");
      document.body.appendChild(newNode);
    }

    if (!pickerDiv)
      pickerDiv = document.getElementById(datePickerDivID);
    if (!iFrameDiv)
      iFrameDiv = document.getElementById(iFrameDivID);

    try {
      iFrameDiv.style.position = "absolute";
      iFrameDiv.style.width = pickerDiv.offsetWidth;
      iFrameDiv.style.height = pickerDiv.offsetHeight ;
      iFrameDiv.style.top = pickerDiv.style.top;
      iFrameDiv.style.left = pickerDiv.style.left;
      iFrameDiv.style.zIndex = pickerDiv.style.zIndex - 1;
      iFrameDiv.style.visibility = pickerDiv.style.visibility ;
      iFrameDiv.style.display = pickerDiv.style.display;
    } catch(e) {
    }

  } catch (ee) {
  }
}

</script>
</body>
</html>
